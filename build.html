<!doctype html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="initial-scale=1, maximum-scale=1,user-scalable=no">
        
        <title>polymer demo ds2014</title>

        <!-- jsapi -->
        <link rel="stylesheet" href="http://js.arcgis.com/3.8/js/esri/css/esri.css">

        <script>
          var dojoConfig = { 
            useDeferredInstrumentation:true
          };
        </script>
        <script src="http://js.arcgis.com/3.8/"></script>

        <link rel="stylesheet" href="styles/main.css">

        <!-- Place your HTML imports here -->
        <script src="../app/bower_components/platform/platform.js"></script>

        
        <!-- <link rel="import"
      href="bower_components/polymer-jsonp/polymer-jsonp.html"> -->
        <!-- <link rel="import" href="elements/jupe-gas-prices.html"> -->
        
    </head>
    <body><polymer-element name="polymer-body" extends="body" assetpath="../app/bower_components/polymer/">

  <script>

  // upgrade polymer-body last so that it can contain other imported elements
  document.addEventListener('polymer-ready', function() {
    
    Polymer('polymer-body', Platform.mixin({

      created: function() {
        this.template = document.createElement('template');
        var body = wrap(document).body;
        var c$ = body.childNodes.array();
        for (var i=0, c; (c=c$[i]); i++) {
          if (c.localName !== 'script') {
            this.template.content.appendChild(c);
          }
        }
        // snarf up user defined model
        window.model = this;
      },

      parseDeclaration: function(elementElement) {
        this.lightFromTemplate(this.template);
      }

    }, window.model));

  });

  </script>

</polymer-element>
<!--
 Copyright 2013 The Polymer Authors. All rights reserved.
 Use of this source code is governed by a BSD-style
 license that can be found in the LICENSE file.
-->
<script src="../app/bower_components/polymer/polymer.js"></script>
<!-- <link rel="import" href="../polymer-dev/polymer.html"> -->

<!--
Copyright 2013 The Polymer Authors. All rights reserved.
Use of this source code is governed by a BSD-style
license that can be found in the LICENSE file.
-->
<!--
/**
 * @module Polymer Elements
 */
/**
 * polymer-jsonp can be used to perform JSONP requests.
 
 * Example:
 *
 *     <polymer-jsonp url="https://clients1.google.com/finance/info?q=GOOG&client=ig&callback="
 *         response="{{data}}"></polymer-jsonp>
 *
 * @class polymer-jsonp
 */
/**
 * Fired when a response is received.
 *
 * @event polymer-response
 */
-->


<polymer-element name="polymer-jsonp" attributes="url response auto bustCache" assetpath="../app/bower_components/polymer-jsonp/">
  <script>
    (function() {
      Polymer('polymer-jsonp', {
        /**
         * The URL target of the request.
         * 
         * @attribute url
         * @type string
         * @default ''
         */
        url: '',
        /**
         * Returns the response object.
         *
         * @attribute response
         * @type Object
         * @default null
         */
        response: null,
        bustCache: false,
        auto: false,
        urlChanged: function() {
          if (this.url && this.auto) {
            this.go();
          }
        },
        /**
         * Performs a JSONP request to the url specified.
         *
         * @method go
         */
        go: function() {
          if (!this.isInFlight()) {
            this.callbackFunc = JSONP_CALLBACK_FUNC_NAME + callbackId++;
            window[this.callbackFunc] = this.respond.bind(this);
            var url = this.url + this.callbackFunc + (this.bustCache ? '&' + Math.random() : '');
            this.addScript(url);
          }
        },
        isInFlight: function() {
          return !!this.script;
        },
        addScript: function(inSrc) {
          this.script = document.createElement('script');
          this.script.src = inSrc;
          this.script.onerror = this.respond.bind(this);
          var s = document.getElementsByTagName('script')[0];
          s.parentNode.insertBefore(this.script, s);
        },
        removeScript: function() {
          if (this.script.parentNode) {
            this.script.parentNode.removeChild(this.script);
          }
          this.script = null;
        },
        respond: function(inResponse) {
          this.response = inResponse;
          this.removeScript();
          delete window[this.callbackFunc];
          this.fire('polymer-response', {response: inResponse});
        }
      });
      var JSONP_CALLBACK_FUNC_NAME = '_polymer_jsonp_callback_';
      var callbackId = 0;
    })();
  </script>
</polymer-element>



<polymer-element name="jupe-gas-prices" extends="polymer-jsonp" assetpath="../app/elements/">
  <script>
    Polymer('jupe-gas-prices', {
      
      gasPrices: [],

      getDisplayValue: function (item) {
        var regular = item.regular;
        return parseFloat(parseFloat(regular.replace('$', '')).toFixed(2));
      },
      
      getMin: function () {
        var found = _.min(this.gasPrices, function (item) { return this.getDisplayValue(item); }, this);
        return this.getDisplayValue(found);
      },

      getMax: function () {
        var found = _.max(this.gasPrices, function (item) { return this.getDisplayValue(item); }, this);
        return this.getDisplayValue(found);
      },

      findGasPrice: function (stateName) {
        var found = _.findWhere(this.gasPrices, { state: stateName });
        return this.getDisplayValue(found);
      },

      ready: function(){
        var me = this;
        this.addEventListener('polymer-response', function () {
          me.gasPrices = JSON.parse(me.response);
          me.fire('got-prices');
        });
      }

    });
  </script>
</polymer-element>


<polymer-element name="jupe-legend" attributes="" assetpath="../app/elements/">
  <template>
    <style>
      /* styles for the custom element itself - lowest specificity */
      :host { 
        display: block;
        bottom: 15px;
        height: 11.5em;
        left: 15px;
        position: absolute !important;
        width: 12em;
        background: #fff;
        font-family: Helvetica, Arial, sans-serif;
        -moz-box-shadow: 0 0 5px #888;
        -webkit-box-shadow: 0 0 5px #888;
        box-shadow: 0 0 5px #888;
        padding: 5px;
        z-index: 40; 
      }
      .legend {
        height: 100%;
        width: 100%;
      }
    </style>
    <div class="legend">
      <div class="tip">
        <strong hidden?="{{hide}}">{{state}}: ${{price}}</strong>
      </div>
    </div>
  </template>
  <script>
    Polymer('jupe-legend', {

      hide: true,
      
      init: function (map, layer) {
        this.legend = new esri.dijit.Legend({
          map: map,
          layerInfos: [{ 'layer': layer, 'title': 'Regular Gas' }]
        }, this.shadowRoot.querySelector('.legend'));
        this.legend.startup();

        layer.on('mouse-over', this.showTip.bind(this));
        layer.on('mouse-out', this.hideTip.bind(this));
      },

      showTip: function (e) {
        this.hide = false;
        this.state = e.graphic.attributes.STATE_NAME;
        this.price = e.graphic.attributes.GAS_DISPLAY;
      },

      hideTip: function () {
        this.hide = true;
      }

    });
  </script>
</polymer-element>



<polymer-element name="jupe-map" attributes="webMapId, basemap, extent, wkId" assetpath="../app/elements/">
  <template>
    <style>
        /*host refers to the custom element itself and has the lowest specificity; thus allowing users to override your styling from the outside*/
        :host { display: block; }
        #map {
          position: absolute;
          top: 0;
          right: 0;
          bottom: 0;
          left: 0;
          margin: 0; 
          padding: 0; 
          height: 100%;
          width: 100%;
        }
      </style>
      <!-- <polymer-jsonp id="jsonpEl" url="http://apify.heroku.com/api/gasprices.json?callback="
    response="{{gasPricesJson}}"></polymer-jsonp> -->
      <jupe-gas-prices id="gasPrices" url="http://apify.heroku.com/api/gasprices.json?callback=" response="{{gasPricesJson}}"></jupe-gas-prices>
      <jupe-legend id="legend"></jupe-legend>
      <div id="map"></div>
  </template>

  <script src="../app/elements/scripts/jupe-map.js"></script>
</polymer-element>


      <!--[if lt IE 10]>
          <p class="browsehappy">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</p>
      <![endif]-->
      
      <div id="loading" class="shadow loading">
        Getting Latest Gas Price Data...
        <img src="http://dl.dropbox.com/u/2654618/loading_gray_circle.gif">
      </div>


      <jupe-map extent="-2332499, -1530060, 2252197, 1856904" wkid="102003"></jupe-map>
      

      <div id="title" class="shadow info">Current Gas Prices by State<img src="../app/images/p_logo.png"></div>
        
      <script src="../app/bower_components/underscore/underscore.js"></script>
      <script>
        // document.addEventListener('WebComponentsReady', function() {
        //     // Perform some behaviour
        // });
      </script>
    </body>
</html>
